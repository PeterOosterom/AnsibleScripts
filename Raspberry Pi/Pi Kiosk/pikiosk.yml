---
  - name: Create raspberry pi kiosk
    hosts: "{{ target_host }}"
    become: yes
    become_user: root
    vars_prompt:
      - name: confirm_target
        prompt: "Is '{{ target_host }}' the correct target host? (yes/no)"
        private: no
    tasks:

      - name: Confirm target host
        fail:
          msg: "Aborted playbook execution. Confirm target host before proceeding."
        when: confirm_target != "yes"

      - name: Install Chromium,unclutter,xdotool and Xvfb if not already installed
        apt:
          name: 
            - chromium-browser
            - xvfb
            - unclutter
            - xdotool
          state: present

      - name: Create the autostart directory if it doesn't exist
        file:
          path: /etc/xdg/lxsession/LXDE-pi
          state: directory
          mode: '0755'
        become: yes

      - name: Create the autostart file
        template:
          src: templates/autostart.j2
          dest: /etc/xdg/lxsession/LXDE-pi/autostart
        become: yes     

      - name: Create the xdotool file
        template:
          src: templates/xdotool.j2
          dest: /etc/xdg/lxsession/LXDE-pi/xdotool.sh
        become: yes 

      - name: Make the xdotool file executable
        file:
          path: /etc/xdg/lxsession/LXDE-pi/xdotool.sh
          mode: "0755"
        become: yes

      - name: Check if X11 or Xvfb is running
        command: pgrep -f "Xorg|Xvfb"
        register: x11_status
        ignore_errors: yes
        changed_when: false  # We don't want to treat this as a change

      - name: Start Xvfb on a different display if X11 is running
        command: Xvfb :1 -screen 0 1280x1024x16 -ac
        async: 1
        poll: 0
        register: xvfb_result
        changed_when: false
        when: x11_status.stdout is not defined

      - name: Wait for Xvfb to start (adjust sleep time as needed)
        wait_for:
          timeout: 60
          state: started
        when: x11_status.stdout is not defined

      - name: Set DISPLAY variable for Chromium
        set_fact:
          display_var: "{{ 'DISPLAY=:1' if x11_status.stdout is not defined else 'DISPLAY=:0' }}"
        delegate_to: localhost
        
      - name: Launch Chromium to create config files
        become: yes
        become_user: "{{ kiosk_user }}"
        command: chromium-browser
        environment:
          DISPLAY: "{{ display_var }}"
        async: 10
        poll: 0
        ignore_errors: yes


      - name: Wait for Chromium to launch (adjust sleep time as needed)
        pause:
          seconds: 10

      - name: Kill Chromium to prevent interference
        shell: pkill chromium-browser || true

      - name: Update Chromium Preferences
        become_user: pi
        command: >
          sed -i 's/"exited_cleanly":false/"exited_cleanly":true/'
          /home/{{ kiosk_user }}/.config/chromium/Default/Preferences

      - name: Update Chromium Preferences (exit_type)
        become_user: pi
        command: >
          sed -i 's/"exit_type":"Crashed"/"exit_type":"Normal"/'
          /home/{{ kiosk_user }}/.config/chromium/Default/Preferences       

      - name: Reboot host and wait for it to restart
        reboot:
          msg: "Reboot initiated by Ansible"
          connect_timeout: 5
          reboot_timeout: 600
          pre_reboot_delay: 0
          post_reboot_delay: 30
          test_command: whoami